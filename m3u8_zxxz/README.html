<h1 id="m3u8-视频在线提取工具-English-version"><a href="#m3u8-视频在线提取工具-English-version" class="headerlink" title="m3u8 视频在线提取工具(English version)"></a>m3u8 视频在线提取工具(<a href="https://github.com/Momo707577045/m3u8-downloader/blob/master/README-EN.md">English version</a>)</h1><p><img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/01.jpeg" alt="界面"></p>
<h3 id="工具在线地址，推荐使用-chrome-浏览器。"><a href="#工具在线地址，推荐使用-chrome-浏览器。" class="headerlink" title="工具在线地址，推荐使用 chrome 浏览器。"></a><a href="http://blog.luckly-mjw.cn/tool-show/m3u8-downloader/index.html">工具在线地址</a>，推荐使用 chrome 浏览器。</h3><h3 id="研发背景"><a href="#研发背景" class="headerlink" title="研发背景"></a>研发背景</h3><ul>
<li><p>m3u8视频格式简介</p>
<ul>
<li>m3u8视频格式原理：将完整的视频拆分成多个 .ts 视频碎片，.m3u8 文件详细记录每个视频片段的地址。</li>
<li>视频播放时，会先读取 .m3u8 文件，再逐个下载播放 .ts 视频片段。</li>
<li>常用于直播业务，也常用该方法规避视频窃取的风险。加大视频窃取难度。</li>
</ul>
</li>
<li><p>鉴于 m3u8 以上特点，无法简单通过视频链接下载，需使用特定下载软件。</p>
<ul>
<li>但软件下载过程繁琐，试错成本高。</li>
<li>使用软件的下载情况不稳定，常出现浏览器正常播放，但软件下载速度慢，甚至无法正常下载的情况。</li>
<li>软件被编译打包，无法了解内部运行机制，不清楚里面到底发生了什么。</li>
</ul>
</li>
<li><p>基于以上原因，开发了本工具。</p>
<p>  <img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/09.jpeg"></p>
</li>
</ul>
<h3 id="工具特点"><a href="#工具特点" class="headerlink" title="工具特点"></a>工具特点</h3><ul>
<li>无需安装，打开网页即可用。</li>
<li>强制下载现有片段，无需等待完整视频下载完成。</li>
<li>操作直观，精确到视频碎片的操作。</li>
</ul>
<h3 id="功能说明"><a href="#功能说明" class="headerlink" title="功能说明"></a>功能说明</h3><p><img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/02.jpeg"><br>【解析下载】输入 m3u8 链接，点击下载视频。<br>【跨域复制代码】当资源出现跨域限制时，点击复制页面代码，在视频页面的控制台输入。将工具注入到视频页面中，解决跨域问题。<br>【重新下载错误片段】当部分视频片段下载失败时，点击该按钮，重新下载错误片段。<br>【强制下载现有片段】将已经下载好的视频片段强制整合下载。可以提前观看已经下载的片段。该操作不影响当前下载进程。<br>【片段Icon】对应每一个 .ts 视频片段的下载情况。「灰色」：待下载，「绿色」：下载成功，「红色」：下载失败。点击红色 Icon 可重新下载对应错误片段。</p>
<h3 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h3><ul>
<li><p>打开视频目标网页，鼠标右键「检查」，或者「开发者工具」，或者按下键盘的「F12」键</p>
</li>
<li><p>找到 network，输入 m3u8，过滤 m3u8 文件。</p>
</li>
<li><p>刷新页面，监听 m3u8 文件。</p>
<p>  <img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/03.jpeg"></p>
</li>
<li><p>找到目标m3u8文件，查看文件内容，是否符合格式。</p>
<ul>
<li><p>如下为索引文件，不是真正的视频 m3u8 文件</p>
<p>  <img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/04.jpeg"></p>
</li>
<li><p>一般内容有许多 ts 字眼的文件才是我们需要的视频 m3u8 文件。</p>
<p>   <img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/05.jpeg"></p>
</li>
</ul>
</li>
<li><p>拷贝这个 m3u8 文件的链接。</p>
<p>  <img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/06.jpeg"></p>
</li>
<li><p>打开工具页面，输入链接，点击「解析下载」。</p>
</li>
<li><p>出现片段 Icon，则证明操作成功，耐心等待视频下载。</p>
</li>
<li><p>片段全部下载成功，将触发浏览器自动下载，下载整合后的完整视频。</p>
</li>
<li><p>如果有片段下载失败，则点击对应片段，或点击「重新下载错误片段」按钮。重新下载错误片段。</p>
<p>  <img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/08.jpeg"></p>
</li>
</ul>
<h3 id="异常情况"><a href="#异常情况" class="headerlink" title="异常情况"></a>异常情况</h3><p>【无法下载，没有显示片段Icon】</p>
<ul>
<li><p>一般由于跨域造成。</p>
</li>
<li><p>点击「跨域复制代码」按钮。</p>
</li>
<li><p>打开视频目标网页的「开发者工具界面」，找到 console 栏。</p>
<p><img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/10.jpeg"></p>
</li>
<li><p>粘贴刚刚复制的内容，回车。</p>
</li>
<li><p>滚动页面到底部，发现工具显示在底部。然后在注入的工具中正常使用。</p>
<p><img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/11.jpeg"></p>
</li>
</ul>
<p>【下载后的视频资源不可看】</p>
<ul>
<li><p>网站对视频源进行了加密操作。不同的视频网站有不同的算法操作。无法通用处理。</p>
</li>
<li><p>一般网站不会有这种情况。爱奇艺，腾讯等大视频网站才会有该安全措施。</p>
<p><img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/12.jpeg"></p>
</li>
</ul>
<h3 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h3><p>【下载并解析 m3u8 文件】</p>
<ul>
<li><p>直接通过 ajax 的 get 请求 m3u8 文件。得到 m3u8 文件的内容字符串。读取字符串进行解析。</p>
</li>
<li><p>需要注意的是，m3u8 文件不是 json 格式，不能将 dataType 设置为 json。<br>【队列下载 ts 视频片段】</p>
</li>
<li><p>同样使用 ajax 的 get 请求视频碎片，一个 ajax 请求一个 ts 视频碎片，但关键点在于，下载的是视频文件，属于二进制数据，需要将 responseType 请求头设置为 arraybuffer。<code>xhr.responseType = &#39;arraybuffer&#39;</code></p>
</li>
<li><p>使用队列下载，是因为视频碎片太多，不可能一次性请求全部。需要分批下载。</p>
</li>
<li><p>同时由于浏览器同源并发限制，视频同时请求数不能过多。本工具设置为并发下载数为 10。<br>【组合 ts 视频片段】</p>
</li>
<li><p>看似很难，但其实使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob">Blob</a> 对象即可将多个 ts 文件整合成一个文件。new Blob()，传入 ts 文件数组。</p>
</li>
<li><p>这里有个小细节需要注意，需要在 new Blob 的第二个参数中设置文件的 MIME 类型，否则将默认为 txt 文件。 <code>const fileBlob = new Blob(fileDataList, { type: &#39;video/MP2T&#39; }) </code><br>【自动下载】</p>
</li>
<li><p>下载，当然先要获得文件链接，即刚生成的 Blob 文件链接。</p>
</li>
<li><p>使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/URL/createObjectURL">URL.createObjectURL</a>，即可得到浏览器内存中，Blob 的文件链接。<code>URL.createObjectURL(fileBlob)</code></p>
</li>
<li><p>最后，使用 a 标签的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/a">a.download</a> 属性，将 a 标签设置为下载功能。主动调用 click 事件<code>a.click()</code>。完成文件自动下载。</p>
<p>  <img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/13.jpeg"></p>
</li>
</ul>
<h3 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h3><p>【整合及自动下载】</p>
<pre><code>    // 下载整合后的TS文件
    downloadFile(fileDataList, fileName, fileType) {
      this.tips = &#39;ts 碎片整合中，请留意浏览器下载&#39;
      const fileBlob = new Blob(fileDataList, { type: &#39;video/MP2T&#39; }) // 创建一个Blob对象，并设置文件的 MIME 类型
      const a = document.createElement(&#39;a&#39;)
      a.download = fileName + &#39;.&#39; + fileType
      a.href = URL.createObjectURL(fileBlob)
      a.style.display = &#39;none&#39;
      document.body.appendChild(a)
      a.click()
      a.remove()
    },
</code></pre>
<p>是的，涉及新知识点的部分只有上面一小段，其他的都是 JS 的基础应用。</p>
<p>除了 vue.js 文件，本工具代码均包含在 index.html 文件里面。包括换行，一共 540 行代码，其中 css 样式 190 行，html 标签 30 行。JS 逻辑代码 300 行。</p>
<p>罗列这些代码量只是想表明，本工具运用到的都只是 JS 的常见知识，并不复杂。鼓励大家多尝试阅读源码，其实看源码并没有想象中的那么困难。</p>
<h3 id="源码链接"><a href="#源码链接" class="headerlink" title="源码链接"></a><a href="https://github.com/Momo707577045/m3u8-downloader/blob/master/index.html">源码链接</a></h3><h3 id="AES-常规解密功能"><a href="#AES-常规解密功能" class="headerlink" title="AES 常规解密功能"></a>AES 常规解密功能</h3><ul>
<li>借助「aes-decryptor.js」，该文件来至 <a href="https://github.com/video-dev/hls.js">hls.js</a></li>
</ul>
<h3 id="MP4-转码功能"><a href="#MP4-转码功能" class="headerlink" title="MP4 转码功能"></a>MP4 转码功能</h3><ul>
<li>借助「mux-mp4.js」，源码来至 <a href="https://github.com/videojs/mux.js#mp4">mux.js</a></li>
<li>但 mux.js 存在一个无法计算视频长度的 bug</li>
<li>本人已 fork 该项目，并修复该 bug，修复后的项目<a href="https://github.com/Momo707577045/mux.js">链接在这里</a></li>
</ul>
<h3 id="第三方接入"><a href="#第三方接入" class="headerlink" title="第三方接入"></a>第三方接入</h3><ul>
<li><p>在 url 中通过 source 参数拼接下载地址即可，如：<code>http://blog.luckly-mjw.cn/tool-show/m3u8-downloader/index.html?source=http://1257120875.vod2.myqcloud.com/0ef121cdvodtransgzp1257120875/3055695e5285890780828799271/v.f230.m3u8</code></p>
</li>
<li><p>系统将自动解析该参数</p>
<p>  <img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/16.jpeg"></p>
</li>
</ul>
<h3 id="油猴插件"><a href="#油猴插件" class="headerlink" title="油猴插件"></a><a href="https://blog.luckly-mjw.cn/tool-show/m3u8-downloader/m3u8-downloader.user.js">油猴插件</a></h3><p><img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/15.jpeg"></p>
<ul>
<li>「跳转下载」即新开页面，打开本工具页面，自动携带并解析目标地址</li>
<li>「注入下载」为解决跨域而生，直接将代码注入到当前视频网站，进行视频下载</li>
<li>插件源码: <a href="https://github.com/Momo707577045/m3u8-downloader/blob/master/m3u8-downloader.user.js">https://github.com/Momo707577045/m3u8-downloader/blob/master/m3u8-downloader.user.js</a></li>
<li>手动添加油猴插件步骤<ul>
<li><p>点击 tamper-monkey「油猴」icon，点击「添加新脚本」</p>
<p><img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/21.jpeg"></p>
</li>
<li><p>在当前位置，粘贴上述链接中的源码</p>
<p><img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/17.jpeg"></p>
<p><img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/18.jpeg"></p>
</li>
<li><p>点击「文本」，「保存」</p>
<p><img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/19.jpeg"></p>
</li>
<li><p>得到如下结果，即为添加成功</p>
<p><img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/20.jpeg"></p>
</li>
</ul>
</li>
</ul>
<h3 id="完结撒花，感谢阅读。"><a href="#完结撒花，感谢阅读。" class="headerlink" title="完结撒花，感谢阅读。"></a>完结撒花，感谢阅读。</h3><p><img src="http://upyun.luckly-mjw.cn/Assets/m3u8-download/14.jpeg"></p>
